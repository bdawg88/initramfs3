From 6352af6692f343c09f0c5037362605543e0efc5b Mon Sep 17 00:00:00 2001
From: gsstudios <josh.lay@exemail.com.au>
Date: Wed, 27 Jan 2016 10:21:55 +1100
Subject: [PATCH] New control. lowmem vm ratio tuning + my own small tweaks.
 Thanks to @DorimanX

---
 res/customconfig/actions/lowmem_reserve      | 29 ++++++++++++++++++++++++++++
 res/customconfig/battery.profile             |  1 +
 res/customconfig/customconfig.xml            |  7 +++++++
 res/customconfig/default.profile             |  1 +
 res/customconfig/extreme_battery.profile     |  1 +
 res/customconfig/extreme_performance.profile |  1 +
 res/customconfig/performance.profile         |  1 +
 sbin/ext/cortexbrain-tune.sh                 |  7 -------
 8 files changed, 41 insertions(+), 7 deletions(-)
 create mode 100644 res/customconfig/actions/lowmem_reserve

diff --git a/res/customconfig/actions/lowmem_reserve b/res/customconfig/actions/lowmem_reserve
new file mode 100644
index 0000000..403c774
--- /dev/null
+++ b/res/customconfig/actions/lowmem_reserve
@@ -0,0 +1,29 @@
+#!/sbin/busybox sh
+
+# $1 - "lowmem_reserve"
+# $2 - value=
+# Created By Dorimanx
+
+if [ "a$2" != "a" ]; then
+	lowmem_reserve=$2;
+
+case "${lowmem_reserve}" in
+	relaxed)
+		echo "48 48" > /proc/sys/vm/lowmem_reserve_ratio;
+	;;
+	default)
+		echo "32 32" > /proc/sys/vm/lowmem_reserve_ratio;
+	;;
+	boosted)
+		echo "24 24" > /proc/sys/vm/lowmem_reserve_ratio;
+	;;
+	high_pressure)
+		echo "16 16" > /proc/sys/vm/lowmem_reserve_ratio;
+	;;
+	*)
+		lowmem_reserve=boosted;
+	;;
+	esac;
+fi;
+
+echo ${lowmem_reserve};
diff --git a/res/customconfig/battery.profile b/res/customconfig/battery.profile
index 9e81c7c..87be29f 100755
--- a/res/customconfig/battery.profile
+++ b/res/customconfig/battery.profile
@@ -117,6 +117,7 @@ sleep_scheduler=sio
 auto_oom=on
 oom_config_screen_on=default
 oom_config_screen_off=default
+lowmem_reserve=default
 dirty_background_ratio=5
 dirty_ratio=20
 zramtweaks=2
diff --git a/res/customconfig/customconfig.xml b/res/customconfig/customconfig.xml
index 2af5604..fda32d5 100755
--- a/res/customconfig/customconfig.xml
+++ b/res/customconfig/customconfig.xml
@@ -394,6 +394,13 @@
 			<spinnerItem name="exterminate" value="exterminate"/> 
 		</spinner>
 
+<spinner description="Here you can set the low memory reserve ratio, higher ratio give you more free RAM if you see that your free RAM is always loaded and device LAG, but it's also uses more battery to gain more free RAM with loaded system. use relaxed ONLY if your free RAM is above 650MB always! if less than 280MB use recommended or high pressure. (Default: Default)" name="Low Memory Reserve" action="lowmem_reserve">
+			<spinnerItem name="Relaxed" value="relaxed"/> 
+			<spinnerItem name="Default" value="default"/> 
+			<spinnerItem name="Boosted" value="boosted"/> 
+			<spinnerItem name="High Pressure" value="high_pressure"/> 
+		</spinner>
+
 		<seekBar description="Dirty background memory buffer, more you set, more memory will be used for write buffer for background operations. Buffer is released on need to free RAM (Default: 5%)" name="Dirty Background ratio" action="generic /proc/sys/vm/dirty_background_ratio" unit="%" min="5" reversed="false" step="5" max="80"/>
 
 		<seekBar description="Dirty real time memory buffer, more you set, more memory will be used for write buffer for real time operations. Buffer is released on need to free RAM (Default: 20%)" name="Dirty ratio" action="generic /proc/sys/vm/dirty_ratio" unit="%" min="5" reversed="false" step="5" max="90"/>
diff --git a/res/customconfig/default.profile b/res/customconfig/default.profile
index 894b79f..252e153 100755
--- a/res/customconfig/default.profile
+++ b/res/customconfig/default.profile
@@ -117,6 +117,7 @@ sleep_scheduler=sio
 auto_oom=on
 oom_config_screen_on=default
 oom_config_screen_off=default
+lowmem_reserve=default
 dirty_background_ratio=5
 dirty_ratio=20
 zramtweaks=2
diff --git a/res/customconfig/extreme_battery.profile b/res/customconfig/extreme_battery.profile
index b151e89..c4b8876 100755
--- a/res/customconfig/extreme_battery.profile
+++ b/res/customconfig/extreme_battery.profile
@@ -117,6 +117,7 @@ sleep_scheduler=noop
 auto_oom=on
 oom_config_screen_on=default
 oom_config_screen_off=default
+lowmem_reserve=default
 dirty_background_ratio=5
 dirty_ratio=20
 zramtweaks=2
diff --git a/res/customconfig/extreme_performance.profile b/res/customconfig/extreme_performance.profile
index 86fa20c..3191e61 100755
--- a/res/customconfig/extreme_performance.profile
+++ b/res/customconfig/extreme_performance.profile
@@ -117,6 +117,7 @@ sleep_scheduler=zen
 auto_oom=on
 oom_config_screen_on=default
 oom_config_screen_off=default
+lowmem_reserve=boosted
 dirty_background_ratio=5
 dirty_ratio=20
 zramtweaks=2
diff --git a/res/customconfig/performance.profile b/res/customconfig/performance.profile
index 3f71791..81e0d4b 100755
--- a/res/customconfig/performance.profile
+++ b/res/customconfig/performance.profile
@@ -117,6 +117,7 @@ sleep_scheduler=zen
 auto_oom=on
 oom_config_screen_on=default
 oom_config_screen_off=default
+lowmem_reserve=boosted
 dirty_background_ratio=5
 dirty_ratio=20
 zramtweaks=2
diff --git a/sbin/ext/cortexbrain-tune.sh b/sbin/ext/cortexbrain-tune.sh
index 039a2f4..ac9de66 100755
--- a/sbin/ext/cortexbrain-tune.sh
+++ b/sbin/ext/cortexbrain-tune.sh
@@ -164,13 +164,6 @@ KERNEL_TWEAKS()
 	else
 		echo "kernel_tweaks disabled";
 	fi;
-	if [ "$cortexbrain_memory" == "on" ]; then
-		echo "32 32" > /proc/sys/vm/lowmem_reserve_ratio;
-
-		log -p i -t "$FILE_NAME" "*** MEMORY_TWEAKS ***: enabled";
-	else
-		echo "memory_tweaks disabled";
-	fi;
 }
 apply_cpu="$2";
 if [ "$apply_cpu" != "update" ]; then
-- 
1.9.1

